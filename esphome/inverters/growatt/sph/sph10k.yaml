# ============================================================================
# Growatt SPH10K-TL3-BH-UP Register Package
# ============================================================================
# PVAutonomy Inverter Registry - Hardware-Verified Version
# 
# Include in your ESPHome config:
#   packages:
#     inverter:
#       url: https://github.com/gshubi/esphome-registry-test
#       file: esphome/inverters/growatt/sph/sph10k.yaml
#       ref: main
#
# Required substitutions:
#   sensor_prefix: "sph10k_haus_01"  (format: {series}_{location}_{number})
#   modbus_controller_id: "inverter_modbus"
#
# Requirements:
#   - VPP Mode must be enabled on inverter (via ShinePhone app)
#   - Battery Operation Mode: "Normal unrestricted" (0)
#
# Last Updated: 2026-01-02
# Verification: Hardware-tested on production SPH10K system
# Source: Core 2 sph10k_sensors.yaml (verified working)
# Naming: Per 03_naming_convention.md - Display names without device prefix
# ============================================================================

sensor:
  # ═══════════════════════════════════════════════════════════════════════════
  # PV STRING 1 - Register 5-6 (U_DWORD)
  # ═══════════════════════════════════════════════════════════════════════════
  
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV1 Power"
    id: ${sensor_prefix}_pv1_power
    address: 5
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    icon: mdi:solar-power-variant
    accuracy_decimals: 0
    filters:
      - multiply: 0.1

  # ═══════════════════════════════════════════════════════════════════════════
  # PV STRING 2 - Register 9-10 (U_DWORD)
  # ═══════════════════════════════════════════════════════════════════════════

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV2 Power"
    id: ${sensor_prefix}_pv2_power
    address: 9
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    icon: mdi:solar-power-variant
    accuracy_decimals: 0
    filters:
      - multiply: 0.1

  # ═══════════════════════════════════════════════════════════════════════════
  # PV ENERGY - Daily/Total (Registers 59-66)
  # ═══════════════════════════════════════════════════════════════════════════

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV1 Energy Today"
    id: ${sensor_prefix}_pv1_energy_today
    address: 59
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    icon: mdi:solar-power-variant
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV1 Energy Total"
    id: ${sensor_prefix}_pv1_energy_total
    address: 61
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    icon: mdi:solar-power-variant
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV2 Energy Today"
    id: ${sensor_prefix}_pv2_energy_today
    address: 63
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    icon: mdi:solar-power-variant
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV2 Energy Total"
    id: ${sensor_prefix}_pv2_energy_total
    address: 65
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    icon: mdi:solar-power-variant
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # ═══════════════════════════════════════════════════════════════════════════
  # INVERTER TEMPERATURE - Register 93
  # ═══════════════════════════════════════════════════════════════════════════

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Inverter Temperature"
    id: ${sensor_prefix}_inverter_temperature
    address: 93
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    icon: mdi:thermometer
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # ═══════════════════════════════════════════════════════════════════════════
  # INVERTER STATUS - Register 1000
  # ═══════════════════════════════════════════════════════════════════════════

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Inverter Status"
    id: ${sensor_prefix}_inverter_status
    address: 1000
    register_type: read
    value_type: U_WORD
    accuracy_decimals: 0
    entity_category: diagnostic
    icon: mdi:information

  # ═══════════════════════════════════════════════════════════════════════════
  # BATTERY SYSTEM - Registers 1009-1014, 1040, 1088, 1103
  # ═══════════════════════════════════════════════════════════════════════════

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery Discharging Power"
    id: ${sensor_prefix}_battery_discharging_power
    address: 1009
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    icon: mdi:battery-arrow-down
    accuracy_decimals: 0
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery Charging Power"
    id: ${sensor_prefix}_battery_charging_power
    address: 1011
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    icon: mdi:battery-arrow-up-outline
    accuracy_decimals: 0
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery Voltage"
    id: ${sensor_prefix}_battery_voltage
    address: 1013
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    icon: mdi:battery
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery SOC"
    id: ${sensor_prefix}_battery_soc
    address: 1014
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "%"
    device_class: battery
    state_class: measurement
    icon: mdi:battery-50
    accuracy_decimals: 0

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery Temperature"
    id: ${sensor_prefix}_battery_temperature
    address: 1040
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    icon: mdi:thermometer
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery Current"
    id: ${sensor_prefix}_battery_current
    address: 1088
    register_type: read
    value_type: S_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    icon: mdi:current-dc
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "BMS Status"
    id: ${sensor_prefix}_bms_status
    address: 1103
    register_type: read
    value_type: U_WORD
    accuracy_decimals: 0
    entity_category: diagnostic
    icon: mdi:battery-check

  # ═══════════════════════════════════════════════════════════════════════════
  # GRID SYSTEM - Registers 1021, 1037
  # ═══════════════════════════════════════════════════════════════════════════

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Grid Power"
    id: ${sensor_prefix}_grid_power
    address: 1021
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    icon: mdi:transmission-tower
    accuracy_decimals: 0
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Local Load Power"
    id: ${sensor_prefix}_local_load_power
    address: 1037
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    icon: mdi:home-lightning-bolt
    accuracy_decimals: 0
    filters:
      - multiply: 0.1

  # ═══════════════════════════════════════════════════════════════════════════
  # AC OUTPUT - Register 1029
  # ═══════════════════════════════════════════════════════════════════════════

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "AC Output Power"
    id: ${sensor_prefix}_ac_output_power
    address: 1029
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    icon: mdi:power-plug
    accuracy_decimals: 0
    filters:
      - multiply: 0.1

  # ═══════════════════════════════════════════════════════════════════════════
  # ENERGY COUNTERS - Registers 1046, 1052, 1056, 1058
  # ═══════════════════════════════════════════════════════════════════════════

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Energy From Grid Total"
    id: ${sensor_prefix}_energy_from_grid_total
    address: 1046
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    icon: mdi:transmission-tower-import
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Energy To Grid Today"
    id: ${sensor_prefix}_energy_to_grid_today
    address: 1052
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    icon: mdi:transmission-tower-export
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Total Load Energy"
    id: ${sensor_prefix}_total_load_energy
    address: 1056
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    icon: mdi:home-lightning-bolt
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Today Load Energy"
    id: ${sensor_prefix}_today_load_energy
    address: 1058
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    icon: mdi:home-lightning-bolt
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

# ═══════════════════════════════════════════════════════════════════════════
# APR CONTROL - Active Power Rate (Register 3)
# ═══════════════════════════════════════════════════════════════════════════

number:
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Active Power Rate"
    id: ${sensor_prefix}_active_power_rate
    address: 3
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"
    icon: mdi:gauge
    min_value: 5
    max_value: 100
    step: 1
    mode: slider
